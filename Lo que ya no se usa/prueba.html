<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medición de Energía</title>
</head>
<body>
    <button id="btnComenzarMedicion">Comenzar Medición</button>
    <button id="btnDetenerMedicion">Detener Medición</button>
    <div id="resultadoMedicion"></div>

    <script>
        let intervalo; // Variable para almacenar el intervalo de medición

        // Función para obtener y mostrar mediciones
        function obtenerMedicion() {
            console.log("Enviando solicitud de medición...");
            fetch("http://192.168.0.19/comenzar_medicion", {
                method: 'GET',
                mode: 'cors',  // Agregar la opción CORS
            })
            .then(response => response.json())
            .then(data => {
                console.log("Datos de medición:", data);
                
                // Mostrar medición en la interfaz
                const nuevaMedicion = document.createElement("div");
                nuevaMedicion.innerHTML = `
                    <p><strong>Corriente RMS:</strong> ${data.corriente_rms} A</p>
                    <p><strong>Voltaje RMS:</strong> ${data.voltaje_rms} V</p>
                    <p><strong>Potencia Activa:</strong> ${data.potencia_activa} W</p>
                    <p><strong>Potencia Aparente:</strong> ${data.potencia_aparente} W</p>
                    <p><strong>Energía:</strong> ${data.energia} kWh</p>
                `;
                document.getElementById("resultadoMedicion").appendChild(nuevaMedicion);

                // Enviar los datos de medición a la base de datos
                enviarDatosAMedidor(data);
            })
            .catch(error => {
                console.error("Error al obtener datos de medición:", error);
            });
        }

        // Función para enviar los datos de medición al servidor (PHP)
        function enviarDatosAMedidor(data) {
            const medidorID = 1; // El ID del medidor que estás utilizando, asegúrate de cambiar esto
            const postData = {
                action: 'add_lectura',
                MedidorID: medidorID,
                Corriente_rms: data.corriente_rms,
                Voltaje_rms: data.voltaje_rms,
                Potencia_activa: data.potencia_activa,
                Potencia_aparente: data.potencia_aparente,
                Energia: data.energia
            };

            fetch("http://localhost/ManejoBaseDeDatos.php", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(data => {
                console.log("Respuesta de la base de datos:", data);
            })
            .catch(error => {
                console.error("Error al enviar datos a la base de datos:", error);
            });
        }

        // Función para iniciar las mediciones cada 10 segundos
        document.getElementById("btnComenzarMedicion").addEventListener("click", function() {
            console.log("Comenzando mediciones...");
            intervalo = setInterval(obtenerMedicion, 10000); // Llama a obtenerMedicion cada 10 segundos
        });

        // Función para detener las mediciones
        document.getElementById("btnDetenerMedicion").addEventListener("click", function() {
            console.log("Deteniendo mediciones...");
            clearInterval(intervalo); // Detiene el intervalo
            document.getElementById("resultadoMedicion").innerHTML += "<p>Medición detenida.</p>";
        });
    </script>
</body>
</html>
